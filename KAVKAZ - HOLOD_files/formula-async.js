var crfx=function(t){"use strict";class u{static canCompareTypes(t){return t===h.TYPE_NUMBER||(t===h.TYPE_DATE||(t===h.TYPE_STRING||(t===h.TYPE_BOOLEAN||(t===h.TYPE_ARRAY||t===h.TYPE_OBJECT))))}static isEqual(e,r){if(h.isDate(e)&&h.isDate(r))return e.getTime()===r.getTime();if(h.isArray(e)&&h.isArray(r)){if(e.length!==r.length)return!1;let t=0;for(const i of e)if(!u.isEqual(i,r[t++]))return!1;return!0}if(h.isObject(e)&&h.isObject(r)){var n=Object.keys(e),s=Object.keys(r);if(n.length!==s.length)return!1;let t=0;for(const a of n){if(!u.isEqual(a,s[t]))return!1;if(!u.isEqual(e[a],r[s[t]]))return!1;t++}return!0}return!(!h.isNaN(e)||!h.isNaN(r))||e===r}static isGreater(e,r){var t=h.getType(e),n=h.getType(r);if(t===n&&this.canCompareTypes(t)){if(t===h.TYPE_ARRAY){let t=0;for(const a of e){if(r.length<t+1)return!0;if(!this.isEqual(a,r[t]))return this.isGreater(a,r[t]);t++}return!1}if(t!==h.TYPE_OBJECT)return!(h.isNaN(e)||!h.isNaN(r))||r<e;{var s=Object.keys(e),i=Object.keys(r);let t=0;for(const u of s){if(i.length<t+1)return!0;if(!this.isEqual(u,i[t]))return this.isGreater(u,i[t]);if(!this.isEqual(e[u],r[i[t]]))return this.isGreater(e[u],r[i[t]]);t++}return!1}}{const o=[h.TYPE_NULL,h.TYPE_NUMBER,h.TYPE_STRING,h.TYPE_OBJECT,h.TYPE_ARRAY,h.TYPE_BOOLEAN,h.TYPE_DATE];return o.indexOf(t)>o.indexOf(n)}}static isLess(t,e){return!this.isEqual(t,e)&&!this.isGreater(t,e)}}class o{static toBoolean(t){return h.isBoolean(t)?t:h.isNumber(t)?!h.isZero(t):h.isString(t)?""!==t:!!h.isObject(t)||(!!h.isArray(t)||!!h.isDate(t))}static toNumber(t){if(h.isString(t)){if(""===t)throw new Error("convert4");if("+infinity"===t.toLowerCase()||"infinity"===t.toLowerCase())return 1/0;if("+inf"===t.toLowerCase()||"inf"===t.toLowerCase())return 1/0;if("-infinity"===t.toLowerCase()||"-inf"===t.toLowerCase())return-1/0;if("nan"===t.toLowerCase())return NaN;if(t.match(/^[+-]?\d+\.?\d*(e[+-]?\d+)?$/i)){var e=parseFloat(t);if(Math.abs(e)>h.DOUBLE_RANGE)throw new Error("convert6");return e}throw new Error("convert5")}if(h.isBoolean(t))return t?1:0;if(h.isNumber(t))return t;if(h.isNull(t))return 0;if(h.isDate(t))return t.getTime();throw new Error("convert1 :: "+h.getType(t)+",number")}static toString(t){if(h.isString(t))return t;if(h.isBoolean(t))return t?"true":"false";if(h.isNumber(t))return t.toString();if(h.isNull(t))return"";if(h.isDate(t)){var e=t.getUTCFullYear();if(9999<e||e<0)throw new Error("convert2 :: "+e);return t.toISOString()}throw new Error("convert1 :: "+h.getType(t)+",string")}static toDate(t){if(h.isDate(t))return t;if(h.isNumber(t)){if(h.isNaN(t))throw new Error("convert7");if(Math.abs(t)>h.TIMESTAMP_RANGE)throw new Error("toDate1");return new Date(t)}if(h.isNull(t))return null;if(h.isString(t)){if(t.match(h.ISO8601_PATTERN)){const s={date:null,time:null,zone:null};var e=t.match(/^\d\d\d\d-\d\d(-\d\d)?/);s.date=e[1]?e[0]:e[0]+"-01";var r=t.match(/([Tt ])(\d\d:\d\d)(:\d\d(\.\d+)?)?/);s.time=r?r[3]?r[2]+r[3]:r[2]+":00":"00:00:00";const i=t.match(/^\d\d\d\d-\d\d(-\d\d)?(.*)/)[2],a=i.match(/([Zz]|[+-]\d\d(:?\d\d)?)$/);!a||"z"===a[0][0].toLowerCase()?s.zone="Z":s.zone=a[2]?a[1]:a[1]+":00";const u=new Date(`${s.date}T${s.time}${s.zone}`);if(Number.isNaN(u.getDay()))throw new Error("toDate1");const o=t.match(/^\d\d\d\d-\d\d-\d\d/);if(o){var n=o[0].split("-"),e=+n[0],r=+n[1]-1,n=+n[2];const l=new Date(Date.UTC(e,r,n));if(l.getUTCFullYear()!==e||l.getUTCMonth()!==r||l.getUTCDate()!==n)throw new Error("toDate1")}return u}throw new Error("toDate1")}throw new Error("convert1 :: "+h.getType(t)+",date")}}class h{static isNull(t){return null===t}static isNumber(t){return"number"==typeof t}static isFinite(t){return Number.isFinite(t)}static hasFractionalPart(t){return Math.trunc(t)!==t}static isInfinite(t){return!Number.isFinite(t)&&!Number.isNaN(t)}static isNaN(t){return Number.isNaN(t)}static isDate(t){return t instanceof Date}static is32BitInteger(t){return!!this.isNumber(t)&&(Math.round(t)===t&&!(t<-this.INT32_RANGE||t>this.INT32_RANGE))}static isBoolean(t){return!0===t||!1===t}static isString(t){return"string"==typeof t}static isArray(t){return t instanceof Array}static isObject(t){return!this.isArray(t)&&(!this.isDate(t)&&("object"==typeof t&&null!==t))}static isZero(t){return 0===t}static getType(t){return this.isNumber(t)?this.TYPE_NUMBER:this.isBoolean(t)?this.TYPE_BOOLEAN:this.isString(t)?this.TYPE_STRING:this.isNull(t)?this.TYPE_NULL:this.isArray(t)?this.TYPE_ARRAY:this.isDate(t)?this.TYPE_DATE:this.isObject(t)?this.TYPE_OBJECT:void 0}static fixNegativeZero(t){return t+0}}h.TYPE_DATE="date",h.TYPE_ARRAY="array",h.TYPE_OBJECT="object",h.TYPE_NUMBER="number",h.TYPE_STRING="string",h.TYPE_BOOLEAN="boolean",h.TYPE_NULL="null",h.ISO8601_PATTERN=new RegExp(["^","\\d\\d\\d\\d","-(0\\d|1[0-2])","(","-([0-2]\\d|3[01])",")?","(","[Tt ]","([01][0-9]|2[0-3])",":[0-5]\\d","(",":[0-5]\\d","(","\\.\\d+",")?",")?",")?","(","[Zz]","|"," ?","[+-]","([01][0-9]|2[0-3])","(",":?[0-5]\\d",")?",")?","$"].join("")),h.TIMESTAMP_RANGE=864e13,h.INT32_RANGE=2147483647,h.DOUBLE_RANGE=17976931348623157e292,h.MONGO_LONG_MIN=-0x8000000000000000,h.MONGO_LONG_MAX=0x7ffffffffffffc00;var m={parseError:{ru:"Ошибка синтаксиса в формуле",en:"Syntax error in formula"},evaluateError:{ru:"Ошибка выполнения формулы",en:"Formula execution error"},validateError:{ru:"Ошибка чтения формулы",en:"Formula reading error"},finalizeError:{ru:"Ошибка выполнения формулы",en:"Formula execution error"},convertError:{ru:"Ошибка формирования запроса",en:"Query preparation error"},preevalError:{ru:"Ошибка формирования запроса",en:"Query preparation error"},pathTypeError:{ru:"Неверный путь",en:"Invalid path"},parse1:{ru:"Комментарий не закрыт, не хватает */",en:"Comment not closed, missing */"},parse2:{ru:'Неожиданный символ "$1"',en:'Unexpected character "$1"'},parse3:{ru:"Ожидается выражение после $1",en:"Expression expected after $1"},parse4:{ru:"Отсутствует аргумент оператора",en:"Missing operator argument"},parse5:{ru:'Ожидается символ "$1"',en:'Expected character "$1"'},parse6:{ru:"Название переменной не может начинаться с цифры ($1)",en:"Variable names must not start with a number ($1)"},parse7:{ru:"Число слишком большое",en:"Too large number"},parse8:{ru:"Незакрытая скобка $1",en:"Missing bracket $1"},parse9:{ru:'Отсутствует символ "$1"',en:'Missing character "$1"'},parse10:{ru:"Неверный тип ключа",en:"Wrong key type"},parse11:{ru:"Ожидается свойство объекта",en:"Object property expected"},parse12:{ru:"Неверный ключ объекта",en:"Wrong object key"},parse13:{ru:"Неожиданный вызов функции",en:"Unexpected function call"},parse14:{ru:"Вызов неизвестной функции: $1",en:"Unknown function call: $1"},parse15:{ru:"Ожидается экспонента ($1)",en:"Expected exponent ($1)"},parse16:{ru:'Незакрытая кавычка после "$1"',en:'Missing quote after "$1"'},parse17:{ru:"Неверный формат даты",en:"Wrong date format"},parse18:{ru:"Ожидается оператор присваивания",en:"Assignment operator expected"},parse19:{ru:"Ожидается идентификатор",en:"Identifier expected"},var1:{ru:'Переменной "$1" не существует',en:'Variable "$1" does not exist'},add1:{ru:"Складывать можно только числа и даты (не $1)",en:"Only numbers and dates can be added (не $1)"},subtract1:{ru:"Невозможно вычесть $1 из $2",en:"Unable to subtract $1 from $2"},mod1:{ru:"Делить (%) на ноль нельзя",en:"(%) cannot be divided by zero"},mod2:{ru:"Невозможно поделить (%) $1 на $2",en:"Unable to divide (%) $1 by $2"},divide1:{ru:"Делить на ноль нельзя",en:"Divide by zero is not allowed"},divide2:{ru:"Невозможно поделить $1 на $2",en:"Unable to divide $1 by $2"},member1:{ru:"Невозможно прочитать свойство типа $2 из $1",en:"Unable to read property of type $2 from $1"},member2:{ru:"Отсутствует свойство объекта или элемент массива ($1)",en:"Missing object property or array element ($1)"},member3:{ru:"Номер элемента массива должен быть целым 32-битным числом",en:"The array element number must be a 32-bit integer"},fn1:{ru:"Функция $1 работает только с массивами (передано $2)",en:"The $1 function works with arrays only ($1 passed)"},arg_1st:{ru:"Первый аргумент",en:"First argument"},arg_2nd:{ru:"Второй аргумент",en:"Second argument"},arg_3rd:{ru:"Третий аргумент",en:"Third argument"},fn2:{ru:"$arg функции $1 должен быть числом (передано $2)",en:"$arg of the $1 function must be a number ($2 passed)"},fn3:{ru:"$arg функции $1 должен быть целым 32-битным числом",en:"$arg of the $1 function must be a 32-bit integer"},fn4:{ru:"$arg функции $1 должен быть строкой",en:"$arg of the $1 function must be a string"},fn5:{ru:"$arg функции $1 должен быть строкой (передано $2)",en:"$arg of the $1 function must be a string ($2 passed)"},fn6:{ru:"Функция $1 работает только со строками (передано $2)",en:"The $1 function works with strings only ($2 passed)"},fn7:{ru:"Функция $1 работает только с числами (передано $2)",en:"The $1 function works with numbers only ($2 passed)"},slice2:{ru:"Третий аргумент ($1) функции slice должен быть положительным числом",en:"The third argument ($1) of the slice function must be a positive number"},slice3:{ru:"Второй аргумент ($1) функции slice должен быть числом",en:"The second argument ($1) of the slice function must be a number"},substr3:{ru:"Второй аргумент функции substr не должен быть отрицательным числом",en:"The second argument of the substr function must not be a negative number"},substr5:{ru:"Третий аргумент функции substr не должен быть отрицательным числом",en:"The third argument of the substr function must not be a negative number"},regexTest3:{ru:"Третий аргумент функции regexTest не может быть выражением",en:"The third argument of the regexTest function cannot be an expression"},regexTest4:{ru:"Третий аргумент функции regexTest содержит неизвестные опции",en:"The third argument of the regexTest function consists of unknown options"},regexMatch3:{ru:"Третий аргумент функции regexMatch не может быть выражением",en:"The third argument of the regexMatch function cannot be an expression"},regexMatch4:{ru:"Третий аргумент функции regexMatch содержит неизвестные опции",en:"The third argument of the regexMatch function consists of unknown options"},regexMatchAll3:{ru:"Третий аргумент функции regexMatchAll не может быть выражением",en:"The third argument of the regexMatchAll function cannot be an expression"},regexMatchAll4:{ru:"Третий аргумент функции regexMatchAll содержит неизвестные опции",en:"The third argument of the regexMatchAll function consists of unknown options"},range7:{ru:"Третий аргумент функции range не может быть 0",en:"The third argument of the range function cannot be 0"},pow3:{ru:"Слишком большое число в результате выполнения функции pow",en:"Too large number as a result of the pow function"},pow4:{ru:"Ошибка выполнения функции pow",en:"Pow function error"},log3:{ru:"Первый аргумент функции log должен быть положительным числом",en:"The first argument of the log function must be a positive number"},log4:{ru:"Второй аргумент функции log должен быть положительным числом не равным 1",en:"The second argument of the log function must be a positive number not equal to 1"},split3:{ru:"Второй аргумент функции split не может быть пустой строкой",en:"The second argument of the split function must not be an empty string"},convert1:{ru:"Невозможно преобразовать $1 в $2",en:"Unable to convert $1 to $2"},convert2:{ru:"Дата, преобразуемая в строку должна быть в пределах 10 тысяч лет",en:"The date converted to a string must be within 10,000 years"},convert3:{ru:"Невозможно преобразовать $1 в $2",en:"Unable to convert $1 to $2"},convert4:{ru:"Невозможно преобразовать пустую строку в число",en:"Unable to convert the empty string to a number"},convert5:{ru:"Невозможно преобразовать строку в число: неверный формат",en:"Unable to convert the string to a number: invalid format"},convert6:{ru:"Невозможно преобразовать строку в число: число слишком велико",en:"Unable to convert the string to a number: the number is too large"},convert7:{ru:"Невозможно преобразовать NaN в число",en:"Cannot convert NaN to integer"},round2:{ru:"Второй аргумент функции round должен быть в диапазоне от -20 до 100",en:"The second argument of the round function must be from -20 to 100"},round3:{ru:"Второй аргумент функции round должен быть целым числом",en:"The second argument of the round function must be an integer"},trunc2:{ru:"Второй аргумент функции trunc должен быть в диапазоне от -20 до 100",en:"The second argument of the trunc function must be from -20 to 100"},sqrt2:{ru:"Функция sqrt не работает с отрицательными числами",en:"The sqrt function does not work with negative numbers"},sin2:{ru:"Функция sin работает только с конечными числами",en:"The sin function works with finite numbers only"},cos2:{ru:"Функция cos работает только с конечными числами",en:"The cos function works with finite numbers only"},atanh2:{ru:"Функция atanh работает только с числами в диапазоне от -1 до 1",en:"The atanh function works with numbers between -1 and 1 only"},acos2:{ru:"Функция acos работает только с числами в диапазоне от -1 до 1",en:"The acos function works with numbers between -1 and 1 only"},acosh2:{ru:"Функция acosh работает только с числами в диапазоне от 1",en:"The acosh function works with numbers in the range from 1"},asin2:{ru:"Функция asin работает только с числами в диапазоне от -1 до 1",en:"The asin function works with numbers between -1 and 1 only"},tan2:{ru:"Функция tan работает только с конечными числами",en:"The tan function works with finite numbers only"},in1:{ru:"Оператор in работает только с массивами (передано $1)",en:"The in operator works with arrays only ($1 passed)"},general1:{ru:"Слишком большое число",en:"Too large number"},toDate1:{ru:"Ошибка преобразования значения в дату",en:"Error converting the value to date"},let1:{ru:"Первый аргумент функции let должен быть статичным объектом",en:"The first argument of the let function must be a static object"},let2:{ru:"Названия переменных в функции let должны содержать только латинские буквы и цифры",en:"Variable names in the let function must consist of Latin letters and numbers only "},indexOf1:{ru:"Первый аргумент функции indexOf должен быть массивом (передано $1)",en:"The first argument of the indexOf function must be an array ($1 passed)"},arrayToObject1:{ru:"Функция arrayToObject работает только с массивами (передано $1)",en:"The arrayToObject function works with arrays only ($1 passed)"},arrayToObject2:{ru:"Функция arrayToObject ожидает массив из пар ключ-значение (передано $1)",en:""},arrayToObject3:{ru:"Функция arrayToObject ожидает массив из пар ключ-значение, где ключ является строкой (передано $1)",en:""},arrayToObject4:{ru:"Функция arrayToObject ожидает массив из пар ключ-значение размером в 2 элемента (передано $1)",en:""},arrayToObject5:{ru:"Функция arrayToObject ожидает, что все элементы будут или массивами или объектами (передано $1, потом $2)",en:""},arrayToObject6:{ru:'Функция arrayToObject ожидает, что все элементы будут объектами с полями "k" и "v", где "k" это строка (передано $1)',en:""},arrayToObject7:{ru:'Функция arrayToObject ожидает массив объектов с двумя полями "k" и "v" (передано $1)',en:""},arrayToObject8:{ru:'Функция arrayToObject ожидает массив объектов с двумя полями "k" и "v", отсутствует одно из них, или оба',en:""},objectToArray1:{ru:"Функция objectToArray работает только с объектами (передано $1)",en:"The objectToArray function works with objects only ($1 passed)"},dateAdd1:{ru:"Аргумент 'unit' функции dateAdd должен быть строкой (передано $1)",en:"The ‘unit’ argument of the dateAdd function must be a string ($1 passed)"},dateAdd2:{ru:"Аргумент 'date' функции dateAdd должен быть датой",en:"The ‘date’ argument of the dateAdd function must be a date"},dateAdd3:{ru:"Аргумент 'unit' функции dateAdd не правильный",en:""},dateAdd4:{ru:"Аргумент 'amount' функции dateAdd должен быть целым числом",en:"The ‘amount’ argument of the date Add function must be an integer"},dateAdd5:{ru:"Аргумент 'amount' функции dateAdd не правильный",en:""},dateSubtract1:{ru:"Аргумент 'unit' функции dateSubtract должен быть строкой (передано $1)",en:"The ‘unit’ argument of the dateSubstract function must be a string ($1 passed)"},dateSubtract2:{ru:"Аргумент 'date' функции dateSubtract должен быть датой",en:"The ‘date’ argument of the dateSubstract function must be a date"},dateSubtract3:{ru:"Аргумент 'unit' функции dateSubtract не правильный",en:""},dateSubtract4:{ru:"Аргумент 'amount' функции dateSubtract должен быть целым числом",en:"The ‘amount’ argument of the dateSubstract function must be an integer"},dateSubtract5:{ru:"Аргумент 'amount' функции dateSubtract не правильный",en:""},exists1:{ru:"Неверный аргумент функции exists",en:""},unique1:{ru:"Первый аргумент функции unique должен быть массивом (передано $1)",en:"The first argument of the unique function must be an array ($1 passed)"},editor:{goto_playground:{ru:"Открыть в песочнице",en:"Open in playground"},playground_href:{ru:"https://cremax.ru/formula-playground",en:"https://crebase.com/formula-playground"}},scope_viewer:{copy_path:{ru:"Скопировать путь: %path%",en:"Copy path: %path%"},copied:{ru:"Скопировано: %path%",en:"Copied: %path%"}},toTable1:{ru:"Ожидался массив, передано $1",en:"Array expected, $1 passed"},toTable2:{ru:"Ожидался массив объектов, найден элемент $1",en:""}};class e{constructor(t){this.Expr=t}}class r extends e{constructor(t,e){if(super(t),this.existsMode=!1,!e||!e.hasOwnProperty("name"))throw new Error("String without name");if(!h.isString(e.name))throw new Error("Name is not string");e.hasOwnProperty("column")?this.column=!!e.column:this.column=!1,this.name=e.name}enableExistsMode(){this.existsMode=!0}optimize(){return this}_evaluate(t){if(this.Expr.checkEvaluationLimits(this),this.column)throw new Error("Column execution is not supported here");return t.hasOwnProperty(this.name)}evaluate(t){if(this._evaluate(t))return t[this.name];if(this.existsMode)return null;throw new Error("var1 :: "+this.name)}evaluateExists(t){return this._evaluate(t)}gatherExternalIdentifiers(){return this.column?["@"+this.name]:[this.name]}preEvaluate(t,e){return this.column||t.includes(this.name)?this:new l(this,e)}toCode(){return this.column?"@"+this.name:this.name}}class l extends e{constructor(t,e=null){super(t.Expr),this.source=t,this.result=t.evaluate(e||{})}optimize(){return this}evaluate(t){return this.Expr.checkEvaluationLimits(this),this.result}gatherExternalIdentifiers(){return[]}preEvaluate(t,e){return this}toCode(){return z.prettyPrint(this.result,!1)}}class n extends e{constructor(t,e){if(super(t),this.arguments=[],e.length>this.maxArguments())throw new Error("Too much arguments");if(e.length<this.minArguments())throw new Error("Not enough arguments");for(const r of e)this.arguments.push(this.Expr.makeNode(r))}minArguments(){return 0}maxArguments(){return 0}optimize(){let e=!0;for(let t=0;t<this.arguments.length;t++)this.arguments[t]=this.arguments[t].optimize(),this.arguments[t]instanceof l||(e=!1);return e?new l(this):this}evaluate(t){}localVariableList(){return[]}gatherExternalIdentifiers(){let e=[];return this.arguments.forEach(t=>{e=[...e,...t.gatherExternalIdentifiers()]}),e=e.filter(t=>!this.localVariableList().includes(t)),e}preEvaluate(t,r){const n=[...t,...this.localVariableList()];let s=!0;return this.arguments.forEach((t,e)=>{this.arguments[e]=t.preEvaluate(n,r),this.arguments[e]instanceof l||(s=!1)}),s||0===Object.keys(this.gatherExternalIdentifiers()).length?new l(this,r):this}toCode(){const t=Object.keys(z.FUNCTIONS).find(t=>z.FUNCTIONS[t]===this.constructor);if(t)return[t,"(",this.arguments.map(t=>t.toCode()).join(", "),")"].join("");var e=Object.keys(z.BINARY_OPERATORS).find(t=>z.BINARY_OPERATORS[t]===this.constructor);if(e)return["(",this.arguments[0].toCode()," "+e+" ",this.arguments[1].toCode(),")"].join("");throw new Error("Unknown function")}}n;n;n;n;n;n;n;n;n;n;class s extends n{minArguments(){return 2}maxArguments(){return 2}evaluate(e){this.Expr.checkEvaluationLimits(this);var r=this.arguments[0].evaluate(e),e=this.arguments[1].evaluate(e);if(h.isArray(e)){let t=!1;for(const n of e)if(u.isEqual(n,r)){t=!0;break}return t}throw new Error("in1 :: "+h.getType(e))}}s.binaryOperatorPrecedence=7;n;n;class i extends n{minArguments(){return 2}maxArguments(){return 2}evaluate(t){this.Expr.checkEvaluationLimits(this);var e=this.arguments[0].evaluate(t),t=this.arguments[1].evaluate(t);return u.isEqual(e,t)}}class a extends n{minArguments(){return 2}maxArguments(){return 2}evaluate(t){this.Expr.checkEvaluationLimits(this);var e=this.arguments[0].evaluate(t),t=this.arguments[1].evaluate(t);return!u.isEqual(e,t)}}a.binaryOperatorPrecedence=i.binaryOperatorPrecedence=6;class c extends n{minArguments(){return 2}maxArguments(){return 2}evaluate(t){this.Expr.checkEvaluationLimits(this);var e=this.arguments[0].evaluate(t),t=this.arguments[1].evaluate(t);return u.isGreater(e,t)}}class g extends n{minArguments(){return 2}maxArguments(){return 2}evaluate(t){this.Expr.checkEvaluationLimits(this);var e=this.arguments[0].evaluate(t),t=this.arguments[1].evaluate(t);return u.isGreater(e,t)||u.isEqual(e,t)}}class f extends n{minArguments(){return 2}maxArguments(){return 2}evaluate(t){this.Expr.checkEvaluationLimits(this);var e=this.arguments[0].evaluate(t),t=this.arguments[1].evaluate(t);return u.isLess(e,t)}}class p extends n{minArguments(){return 2}maxArguments(){return 2}evaluate(t){this.Expr.checkEvaluationLimits(this);var e=this.arguments[0].evaluate(t),t=this.arguments[1].evaluate(t);return u.isLess(e,t)||u.isEqual(e,t)}}p.binaryOperatorPrecedence=f.binaryOperatorPrecedence=g.binaryOperatorPrecedence=c.binaryOperatorPrecedence=7;n;n;n;class d extends n{constructor(t,e){super(t,e.map(t=>({type:"CallExpression",arguments:[t],callee:"toBoolean",location:[0,0]})))}minArguments(){return 2}maxArguments(){return 10}optimize(){let t=0;for(const e of this.arguments)this.arguments[t++]=e.optimize();for(const r of this.arguments)if(r instanceof l&&!r.result)return this.arguments=[r],new l(this);return this}evaluate(t){this.Expr.checkEvaluationLimits(this);const e=[];for(const r of this.arguments)if(r instanceof l){if(!r.evaluate(t))return!1}else e.push(r);for(const n of e)if(!n.evaluate(t))return!1;return!0}}d.binaryOperatorPrecedence=2;n;class E extends n{constructor(t,e){super(t,e.map(t=>({type:"CallExpression",arguments:[t],callee:"toBoolean",location:[0,0]})))}minArguments(){return 2}maxArguments(){return 10}optimize(){let t=0;for(const e of this.arguments)this.arguments[t++]=e.optimize();for(const r of this.arguments)if(r instanceof l&&r.result)return this.arguments=[r],new l(this);return this}evaluate(t){this.Expr.checkEvaluationLimits(this);const e=[];for(const r of this.arguments)if(r instanceof l){if(r.evaluate(t))return!0}else e.push(r);for(const n of e)if(n.evaluate(t))return!0;return!1}}E.binaryOperatorPrecedence=1;n;class w extends n{minArguments(){return 2}maxArguments(){return 2}assertId(t,e=!1){if(/^[a-z]+[a-zA-Z0-9_]*$/.test(t))return!0;if(e)return!1;throw new Error("let2 :: "+t)}optimize(){return this}evaluate(t){if(this.Expr.checkEvaluationLimits(this),!(this.arguments[0]instanceof $))throw new Error("let1");for(const e in this.arguments[0].object){if(!w.IDRE.test(e))throw new Error("let2 :: "+e);(t=Object.assign({},t))[e]=this.arguments[0].object[e].evaluate(t)}return this.arguments[1].evaluate(t)}gatherExternalIdentifiers(){let e=[],t=[];for(var[r,n]of Object.entries(this.arguments[0].object))this.assertId(r),t=[...t,...n.gatherExternalIdentifiers().filter(t=>!e.includes(t))],e.push(r);return t=[...t,...this.arguments[1].gatherExternalIdentifiers().filter(t=>!e.includes(t))],t}preEvaluate(t,e){const r=[...t];let n=!0;for(var[s,i]of Object.entries(this.arguments[0].object))this.assertId(s),this.arguments[0].object[s]=i.preEvaluate(r,e),this.arguments[0].object[s]instanceof l?(e=Object.assign({},e))[s]=this.arguments[0].object[s].evaluate(e):(n=!1,r.push(s));return this.arguments[1]=this.arguments[1].preEvaluate(r,e),this.arguments[1]instanceof l||(n=!1),n||0===Object.keys(this.gatherExternalIdentifiers()).length?new l(this,e):this}}w.IDRE=/^[a-z]+[a-zA-Z0-9_]*$/;class v extends n{minArguments(){return 2}maxArguments(){return 2}evaluate(t){this.Expr.checkEvaluationLimits(this);var e=this.arguments[0].evaluate(t),t=this.arguments[1].evaluate(t);if(h.isNull(e)||h.isNull(t))return null;if(!h.isNumber(e)||!h.isNumber(t))throw new Error("divide2 :: "+h.getType(e)+","+h.getType(t));if(h.isZero(t))throw new Error("divide1");return e/t}}class y extends n{minArguments(){return 2}maxArguments(){return 2}evaluate(t){this.Expr.checkEvaluationLimits(this);var e=this.arguments[0].evaluate(t),t=this.arguments[1].evaluate(t);if(h.isNull(e)||h.isNull(t))return null;if(!h.isNumber(e)||!h.isNumber(t))throw new Error("mod2 :: "+h.getType(e)+","+h.getType(t));if(h.isZero(t))throw new Error("mod1");return e%t}}n;n;class x extends n{minArguments(){return 1}maxArguments(){return 1}optimize(){if(this.arguments[0]instanceof P){const n=[];for(const s of this.arguments[0].array)if(s instanceof x)if(s.arguments[0]instanceof P)for(const i of s.arguments[0].array)n.push(i);else n.push(s);else n.push(s);this.arguments[0].array=n;let t=[],e=[];for(const a of this.arguments[0].array){var r=a.optimize();(r instanceof l?t:e).push(r)}if(t.length&&(1<t.length&&(this.arguments[0].array=t,t=[new l(this)]),this.arguments[0].array=[...e,...t]),!e.length)return new l(this)}return this}multiply(t){if(h.isNull(t))return null;if(h.isNumber(t)){if(h.isFinite(t)&&(t>h.MONGO_LONG_MAX||t<h.MONGO_LONG_MIN))throw new Error("general1");return this.result*=t}throw new Error("fn7 :: multiply,"+h.getType(t))}evaluate(t){if(this.Expr.checkEvaluationLimits(this),this.result=1,this.arguments[0]instanceof P){for(const r of this.arguments[0].array)if(null===this.multiply(r.evaluate(t)))return null}else{var e=this.arguments[0].evaluate(t);if(h.isNull(e))return null;if(!h.isArray(e))throw new Error("fn7 :: multiply,"+h.getType(e));for(const n of e)if(null===this.multiply(n))return null}return this.result}}x.binaryOperatorPrecedence=y.binaryOperatorPrecedence=v.binaryOperatorPrecedence=10;class b extends n{minArguments(){return 2}maxArguments(){return 2}evaluate(t){this.Expr.checkEvaluationLimits(this);var e=this.arguments[0].evaluate(t),t=this.arguments[1].evaluate(t);if(h.isNull(e)||h.isNull(t))return null;if(h.isDate(e)&&h.isNumber(t))return o.toDate(o.toNumber(e)-t);if(!h.isNumber(e)||!h.isNumber(t))throw new Error("subtract1 :: "+h.getType(t)+","+h.getType(e));return e-t}}b.binaryOperatorPrecedence=9;class T extends n{constructor(){super(...arguments),this.isDate=!1}minArguments(){return 1}maxArguments(){return 1}optimize(){if(this.arguments[0]instanceof P){const n=[];for(const s of this.arguments[0].array)if(s instanceof T)if(s.arguments[0]instanceof P)for(const i of s.arguments[0].array)n.push(i);else n.push(s);else n.push(s);this.arguments[0].array=n;let t=[],e=[];for(const a of this.arguments[0].array){var r=a.optimize();(r instanceof l?t:e).push(r)}if(t.length&&(1<t.length&&(this.arguments[0].array=t,t=[new l(this)]),this.arguments[0].array=[...e,...t]),!e.length)return new l(this)}return this}add(t){if(h.isNull(t))return null;if(h.isNumber(t))return this.result+=t;if(h.isDate(t))return this.isDate=!0,this.result+=o.toNumber(t);throw new Error("add1 :: "+h.getType(t))}evaluate(t){if(this.Expr.checkEvaluationLimits(this),this.result=0,this.arguments[0]instanceof P){for(const r of this.arguments[0].array)if(null===this.add(r.evaluate(t)))return null}else{var e=this.arguments[0].evaluate(t);if(h.isNull(e))return null;if(!h.isArray(e))throw new Error("add1 :: "+h.getType(e));for(const n of e)if(null===this.add(n))return null}return this.isDate?o.toDate(this.result):this.result}}T.binaryOperatorPrecedence=9;n;n;n;n;n;n;n;n;n;n;n;n;n;n;n;n;n;n;n;n;n;n;n;class N extends n{minArguments(){return 1}maxArguments(){return 2}optimize(){if(this.arguments[0]instanceof P)if(1===this.arguments.length){const e=[];for(const r of this.arguments[0].array)if(r instanceof N)if(1===r.arguments.length&&r.arguments[0]instanceof P)for(const n of r.arguments[0].array)e.push(n);else e.push(r);else e.push(r);this.arguments[0].array=e;let t=0;for(const s of this.arguments[0].array){const i=s.optimize();i instanceof l&&(i.result=o.toString(i.result),this.arguments[0].array[t]=i),t++}}else this.arguments[0]=this.arguments[0].optimize(),this.arguments[1]=this.arguments[1].optimize();return this}evaluate(t){this.Expr.checkEvaluationLimits(this);var r=this.arguments[0].evaluate(t);let n="";if(1<this.arguments.length&&(n=this.arguments[1].evaluate(t)),h.isString(r))return r;if(h.isNull(r))return"";if(h.isArray(r)){if(!h.isString(n))throw new Error("fn5 :: join,2nd,"+h.getType(n));let t="",e=0;for(const s of r)0<e++&&(t+=n),h.isNull(s)||(t+=o.toString(s));return t}throw new Error("fn6 :: join,"+h.getType(r))}}N.binaryOperatorPrecedence=8;n;n;n;class A extends n{minArguments(){return 1}maxArguments(){return 1}trim(t,e){let r=0,n=t.length;for(;r<n&&0<=e.indexOf(t[r]);)++r;for(;n>r&&0<=e.indexOf(t[n-1]);)--n;return 0<r||n<t.length?t.substring(r,n):t}evaluate(t){this.Expr.checkEvaluationLimits(this);t=this.arguments[0].evaluate(t);if(h.isNull(t))return null;if(h.isString(t))return this.trim(t,A.WHITESPACE);throw new Error("fn6 :: trim,"+h.getType(t))}}A.WHITESPACE="\0 \t\n\v\f\r             ";n;n;n;n;n;n;n;class O extends n{minArguments(){return 2}maxArguments(){return 3}static validateFlags(t){return null!==t.match(/^[ims]*$/)}optimize(){if(this.arguments[1]=this.arguments[1].optimize(),this.arguments[1]instanceof l&&!h.isNull(this.arguments[1].result)&&!h.isString(this.arguments[1].result))throw new Error("fn4 :: regexTest,2nd");return this}evaluate(t){this.Expr.checkEvaluationLimits(this);var e=this.arguments[0].evaluate(t),r=this.arguments[1].evaluate(t);if(h.isNull(e))return!1;if(!h.isString(e))throw new Error("fn4 :: regexTest,1st");if(h.isNull(r))return!1;if(!h.isString(r))throw new Error("fn4 :: regexTest,2nd");let n="";if(2<this.arguments.length){if(!(this.arguments[2]instanceof j))throw new Error("regexTest3");if(n=this.arguments[2].evaluate(t),!O.validateFlags(n))throw new Error("regexTest4")}let s;try{s=new RegExp(r,n+"u")}catch(t){throw new Error("regexTest3")}return s.test(e)}}n;n;n;n;n;n;n;class k extends n{constructor(t,e){super(t,e),this.arguments[0]instanceof D&&this.arguments[0].disableNullSafety()}minArguments(){return 1}maxArguments(){return 2}evaluate(t){this.Expr.checkEvaluationLimits(this);var e=this.arguments[0].evaluate(t);return 1<this.arguments.length?null!=e?e:this.arguments[1].evaluate(t):null!=e?e:null}}k.binaryOperatorPrecedence=11,k.rightAssociative=!0;n;n;n;class M extends e{constructor(t,e){if(super(t),!e||!e.hasOwnProperty("value"))throw new Error("Number without value");if("NaN"!==e.value)if("Infinity"!==e.value){if(!h.isNumber(e.value))throw new Error("Number is not number");this.value=e.value}else this.value=1/0;else this.value=NaN}optimize(){return new l(this)}evaluate(t){return this.Expr.checkEvaluationLimits(this),this.value}gatherExternalIdentifiers(){return[]}preEvaluate(t,e){return new l(this,e)}toCode(){return z.prettyPrint(this.value)}}class j extends e{constructor(t,e){if(super(t),!e||!e.hasOwnProperty("value"))throw new Error("String without value");if(!h.isString(e.value))throw new Error("String is not string");this.value=e.value}optimize(){return new l(this)}evaluate(t){return this.Expr.checkEvaluationLimits(this),this.value}gatherExternalIdentifiers(){return[]}preEvaluate(t,e){return new l(this,e)}toCode(){return z.prettyPrint(this.value)}}class L extends e{constructor(t,e){if(super(t),!e||!e.hasOwnProperty("value"))throw new Error("Date without value");if(!h.isString(e.value))throw new Error("Date is not string");this.value=e.value}optimize(){return new l(this)}evaluate(t){return this.Expr.checkEvaluationLimits(this),new Date(this.value)}gatherExternalIdentifiers(){return[]}preEvaluate(t,e){return new l(this,e)}toCode(){return z.prettyPrint(this.value)}}class S extends e{constructor(t,e){super(t),this.value=null}optimize(){return new l(this)}evaluate(t){return this.Expr.checkEvaluationLimits(this),this.value}gatherExternalIdentifiers(){return[]}preEvaluate(t,e){return new l(this,e)}toCode(){return z.prettyPrint(this.value)}}class _ extends e{constructor(t,e){if(super(t),!e||!e.hasOwnProperty("value"))throw new Error("Boolean without value");if(!h.isBoolean(e.value))throw new Error("Boolean is not boolean");this.value=e.value}optimize(){return new l(this)}evaluate(t){return this.Expr.checkEvaluationLimits(this),this.value}gatherExternalIdentifiers(){return[]}preEvaluate(t,e){return new l(this,e)}toCode(){return z.prettyPrint(this.value)}}class $ extends e{constructor(t,e){if(super(t),!e)throw new Error("Wrong node");if(!e.hasOwnProperty("properties"))throw new Error("Object without properties");this.object={};for(const r of e.properties){if(!r.hasOwnProperty("key"))throw new Error("Object property without key");if("string"!=typeof r.key)throw new Error("Object property key is not string");if(!r.hasOwnProperty("value"))throw new Error("Object property without value");this.object[r.key]=this.Expr.makeNode(r.value)}}optimize(){let t=!0;for(const e in this.object)this.object[e]=this.object[e].optimize(),this.object[e]instanceof l||(t=!1);return t?new l(this):this}evaluate(t){this.Expr.checkEvaluationLimits(this);const e={};for(const r in this.object)e[r]=this.object[r].evaluate(t);return e}gatherExternalIdentifiers(){let t=[];for(const e in this.object)t=[...t,...this.object[e].gatherExternalIdentifiers()];return t}preEvaluate(t,e){let r=!0;for(var[n,s]of Object.entries(this.object))this.object[n]=s.preEvaluate(t,e),this.object[n]instanceof l||(r=!1);return r?new l(this,e):this}toCode(){return["{",Object.keys(this.object).map(t=>z.prettyPrint(t)+": "+this.object[t].toCode()).join(", "),"}"].join("")}}class P extends e{constructor(t,e){if(super(t),!e)throw new Error("Wrong node");if(!e.hasOwnProperty("elements"))throw new Error("Array without elements");this.array=[];for(const r of e.elements)this.array.push(this.Expr.makeNode(r))}optimize(){let e=!0;for(let t=0;t<this.array.length;t++)this.array[t]=this.array[t].optimize(),this.array[t]instanceof l||(e=!1);return e?new l(this):this}evaluate(t){this.Expr.checkEvaluationLimits(this);const e=[];for(const r of this.array)e.push(r.evaluate(t));return e}gatherExternalIdentifiers(){let e=[];return this.array.forEach(t=>{e=[...e,...t.gatherExternalIdentifiers()]}),e}preEvaluate(t,e){let r=!0;for(var[n,s]of Object.entries(this.array))this.array[n]=s.preEvaluate(t,e),this.array[n]instanceof l||(r=!1);return r?new l(this,e):this}toCode(){return["[",this.array.map(t=>t.toCode()).join(", "),"]"].join("")}}class D extends e{constructor(t,e){if(super(t),this.nullSafe=!0,this.existsMode=!1,!e)throw new Error("Wrong node");if(!e.hasOwnProperty("object"))throw new Error("Member expression without object");if(!e.hasOwnProperty("property"))throw new Error("Member expression without property");this.object=this.Expr.makeNode(e.object),this.property=this.Expr.makeNode(e.property)}disableNullSafety(){this.nullSafe=!1,this.object instanceof D&&this.object.disableNullSafety()}enableExistsMode(){this.existsMode=!0,(this.object instanceof D||this.object instanceof r)&&this.object.enableExistsMode()}optimize(){return this.object=this.object.optimize(),this.property=this.property.optimize(),this}evaluate(t,e=0){this.Expr.checkEvaluationLimits(this);const r=this.object.evaluate(t);var n=this.property.evaluate(t);if(h.isNull(r)&&!1===this.nullSafe)return null;if(h.isArray(r)&&h.isNumber(n)){if(h.is32BitInteger(n)){t=n<0?r.length+n:n;if(r.hasOwnProperty(t))return r[t];if(this.nullSafe)throw this.existsMode?new Error("undefined"):new Error("member2 :: "+n);return null}throw new Error("member3")}if(h.isObject(r)&&h.isString(n)){if(r.hasOwnProperty(n))return r[n];if(this.nullSafe)throw this.existsMode?new Error("undefined"):new Error("member2 :: "+n);return null}throw this.existsMode?new Error("undefined"):new Error("member1 :: "+h.getType(r)+","+h.getType(n))}evaluateExists(t){try{return this.evaluate(t),!0}catch(t){if("undefined"===t.message)return!1;throw t}}gatherExternalIdentifiers(){return[...this.object.gatherExternalIdentifiers(),...this.property.gatherExternalIdentifiers()]}preEvaluate(t,e){return this.object=this.object.preEvaluate(t,e),this.property=this.property.preEvaluate(t,e),this.object instanceof l&&this.property instanceof l?new l(this,e):this}toCode(){return[this.object.toCode(),"[",this.property.toCode(),"]"].join("")}}class z{constructor(t,e){if(this.limitMode=0,void(this.evaluationCounter=0)===e)throw new Error("limitNode is required");this.ast=t,this.limitMode=e}isEmpty(){return null===this.ast.error&&null===this.ast.source}makeNode(e){if(!e||!e.hasOwnProperty("type"))throw new Error("Node without type");if("CallExpression"===e.type){if(!e.hasOwnProperty("arguments"))throw new Error("Call expression without arguments");if(!e.hasOwnProperty("callee"))throw new Error("Call expression without callee");if(!z.FUNCTIONS[e.callee])throw new Error("Unknown function call");return new z.FUNCTIONS[e.callee](this,e.arguments)}if("UnaryExpression"===e.type){if(!e.hasOwnProperty("argument"))throw new Error("Unary operator without argument");if(!e.hasOwnProperty("operator"))throw new Error("Unary operator without operator");if("+"===e.operator)return new T(this,[{type:"ArrayExpression",elements:[{type:"Number",value:0,location:[0,0]},e.argument],location:[0,0]}]);if("-"===e.operator)return new b(this,[{type:"Number",value:0,location:[0,0]},e.argument]);if("?"===e.operator)return new k(this,[e.argument,{type:"Null",location:[0,0]}]);throw new Error("Unknown unary operator")}if("BinaryExpression"===e.type){if(!e.hasOwnProperty("left"))throw new Error("Binary operator without left");if(!e.hasOwnProperty("right"))throw new Error("Binary operator without right");if(!z.BINARY_OPERATORS[e.operator])throw new Error("Unknown binary operator");let t;return t=["&","+","*"].includes(e.operator)?[{type:"ArrayExpression",elements:[e.left,e.right],location:[0,0]}]:[e.left,e.right],new z.BINARY_OPERATORS[e.operator](this,t)}if(!z.NODES[e.type])throw new Error("Unknown node type");return new z.NODES[e.type](this,e)}resetEvaluationLimits(){this.evaluationCounter=0}checkEvaluationLimits(t){if(this.limitMode&&t instanceof n){if(this.evaluationCounter++,this.limitMode===z.LIMIT_MODE_10K&&1e4<this.evaluationCounter)throw new Error("Limit 10k exceeded");if(this.limitMode===z.LIMIT_MODE_1M&&1e6<this.evaluationCounter)throw new Error("Limit 1 million exceeded")}}evaluate(t){this.resetEvaluationLimits();var e=Date.now();if(this.isEmpty())return{error:null,result:null,time:Date.now()-e};if(null!==this.ast.error)return{error:"parse :: "+this.ast.error.message,result:null,time:Date.now()-e};try{const r=this.makeNode(this.ast.source);try{const n=r.optimize();try{return{error:null,result:n.evaluate(t),time:Date.now()-e}}catch(t){return{error:"evaluate :: "+t.message,result:null,time:Date.now()-e}}}catch(t){return{error:"optimize :: "+t.message,result:null,time:Date.now()-e}}}catch(t){return{error:"validate :: "+t.message,result:null,time:Date.now()-e}}}evaluateToBoolean(t){t=this.evaluate(t);if(t.error)return t;try{return{error:null,result:o.toBoolean(t.result)}}catch(t){return{error:"finalize :: "+t.message,result:null}}}evaluateToString(t){t=this.evaluate(t);if(t.error)return t;try{return{error:null,result:o.toString(t.result)}}catch(t){return{error:"finalize :: "+t.message,result:null}}}evaluateToNumber(t){t=this.evaluate(t);if(t.error)return t;try{return{error:null,result:o.toNumber(t.result)}}catch(t){return{error:"finalize :: "+t.message,result:null}}}evaluateToTable(t){t=this.evaluate(t);if(t.error)return t;try{return{error:null,result:class{static perform(e){if(h.isNull(e))return{columns:[],rows:[],total_count:0};if(h.isArray(e)){if(0===e.length)return{columns:[],rows:[],total_count:0};{let t=null;var r=e.map(e=>{if(!h.isObject(e))throw new Error("toTable2 :: "+h.getType(e));null===t&&(t=Object.keys(e));let r={};return t.forEach(t=>{r[t]=null!==(t=e[t])&&void 0!==t?t:null}),r});return{columns:t.map(t=>({id:t,name:t,type:"any"})),rows:r,total_count:e.length}}}throw new Error("toTable1 :: "+h.getType(e))}}.perform(t.result)}}catch(t){return{error:"finalize :: "+t.message,result:null}}}static prettyPrint(t,e=""){var r=!1===e;const n=!r&&e+"  ";if(h.isObject(t)){if(0===Object.keys(t).length)return"{}";{const s=[];for(const i in t)s.push([r?"":n,JSON.stringify(i),": ",z.prettyPrint(t[i],n)].join(""));return[r?"{":"{\n",s.join(r?", ":",\n"),r?"}":"\n"+e+"}"].join("")}}if(h.isArray(t)){if(0===t.length)return"[]";{const a=[];for(const u of t)a.push([r?"":n,z.prettyPrint(u,n)].join(""));return[r?"[":"[\n",a.join(r?", ":",\n"),r?"]":"\n"+e+"]"].join("")}}if(h.isDate(t))return"#"+o.toString(t)+"#";if(h.isString(t))return JSON.stringify(o.toString(t));if(h.isNumber(t))return o.toString(t);if(h.isNull(t))return"null";if(h.isBoolean(t))return o.toString(t);throw new Error("Unknown type")}static encodeTypes(e){if(h.isDate(e))return{__formula_encoded_type__:"date",date:o.toString(e)};if(h.isArray(e)){const r=[...e];let t=0;for(const n of r)r[t++]=this.encodeTypes(n);return r}if(h.isObject(e)){const t=Object.assign({},e);for(const s in t)t[s]=this.encodeTypes(t[s]);return t}return Number.isNaN(e)?{__formula_encoded_type__:"NaN"}:e===1/0?{__formula_encoded_type__:"Infinity"}:e===-1/0?{__formula_encoded_type__:"-Infinity"}:e}static encodeDataToJSON(t,e=!1){return JSON.stringify(this.encodeTypes(t),null,e?2:null)}static decodeTypes(e){if(void 0!==(null==e?void 0:e.__formula_encoded_type__))return"date"===e.__formula_encoded_type__?o.toDate(e.date||e.timestamp):"NaN"===e.__formula_encoded_type__?NaN:"Infinity"===e.__formula_encoded_type__?1/0:"-Infinity"===e.__formula_encoded_type__?-1/0:e;if(h.isArray(e)){const r=[...e];let t=0;for(const n of r)r[t++]=this.decodeTypes(n);return r}if(h.isObject(e)){const t=Object.assign({},e);for(const s in t)t[s]=this.decodeTypes(t[s]);return t}return e}static decodeDataFromJSON(t){return this.decodeTypes(JSON.parse(t))}static deepClone(t){return this.decodeDataFromJSON(this.encodeDataToJSON(t))}preEvaluate(e){var r=Date.now();if(this.isEmpty())return{error:null,result:null,time:Date.now()-r};if(null!==this.ast.error)return{error:"parse :: "+this.ast.error.message,result:null,time:Date.now()-r};try{let t=this.makeNode(this.ast.source);try{t=t.preEvaluate([],e)}catch(t){return{error:"preeval :: "+t.message,result:null}}try{return{error:null,result:t.toCode()}}catch(t){return{error:"convert :: "+t.message,result:null}}}catch(t){return{error:"validate :: "+t.message,result:null,time:Date.now()-r}}}}return z.ErrorTranslator=class{static hasTranslationFor(t){t=t.split(" :: ");return void 0!==m[t[1]]}static translateTo(e,r){try{const o=e.split(" :: ");var t=o[0];if("optimize"===t||"evaluate"===t){var n=o[1],s=2<o.length?o[2].split(","):[];if(m.hasOwnProperty(n)){let t=m[n][r],e=1;for(const l of s)t=t.replace("$"+e++,l);return`${m.evaluateError.ru}: ${t}`}return`${m.evaluateError.ru}: ${e}`}if(["parse","validate","finalize","convert","preeval"].includes(t)){var i=o[1],a=o[2],u=m[i][r].replace("$1",a);return`${m[t+"Error"].ru}: ${u}`}return e}catch(t){return e}}static toRussian(t){return this.translateTo(t,"ru")}},z.Typing=h,z.Comparison=u,z.NODES={Number:M,String:j,Date:L,Boolean:_,Null:S,Identifier:r,ObjectExpression:$,ArrayExpression:P,MemberExpression:D},z.FUNCTIONS={if:class extends n{minArguments(){return 3}maxArguments(){return 101}constructor(t,e){if(0<(e.length-1)%2)throw new Error("Wrong argument count");e=[...e];for(let t=0;t<e.length-1;t+=2)e[t]={type:"CallExpression",arguments:[e[t]],callee:"toBoolean",location:[0,0]};super(t,e)}evaluate(e){this.Expr.checkEvaluationLimits(this);for(let t=0;t<this.arguments.length-1;t+=2)if(this.arguments[t].evaluate(e))return this.arguments[t+1].evaluate(e);return this.arguments[this.arguments.length-1].evaluate(e)}},mod:y,multiply:x,sum:T,round:class extends n{minArguments(){return 1}maxArguments(){return 2}roundHalfToEven(t){return.5===Math.abs(t%1)?2*Math.round(t/2):Math.round(t)}roundHalfTowardZero(t){return.5===Math.abs(t%1)?Math.round(t-.5*Math.sign(t)):Math.round(t)}evaluate(t){this.Expr.checkEvaluationLimits(this);var e=this.arguments[0].evaluate(t);let r=0;if(1<this.arguments.length&&(r=this.arguments[1].evaluate(t)),h.isNull(e)||h.isNull(r))return null;if(!h.isNumber(e))throw new Error("fn7 :: round,"+h.getType(e));if(!h.isNumber(r))throw new Error("convert3 :: "+h.getType(r)+",number");if(!h.isFinite(r))throw new Error("general1");if(h.hasFractionalPart(r))throw new Error("round3");if(r<-20||100<r)throw new Error("round2 :: "+r);t=Math.pow(10,Math.abs(r)),t=r<0?1/t:t;return 0<r?h.fixNegativeZero(this.roundHalfTowardZero(e*t)/t):h.fixNegativeZero(this.roundHalfToEven(e*t)/t)}},floor:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(t){this.Expr.checkEvaluationLimits(this);t=this.arguments[0].evaluate(t);if(h.isNull(t))return null;if(!h.isNumber(t))throw new Error("fn7 :: floor,"+h.getType(t));return Math.floor(t)}},ceil:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(t){this.Expr.checkEvaluationLimits(this);t=this.arguments[0].evaluate(t);if(h.isNull(t))return null;if(!h.isNumber(t))throw new Error("fn7 :: ceil,"+h.getType(t));return Math.ceil(t)}},abs:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(t){this.Expr.checkEvaluationLimits(this);t=this.arguments[0].evaluate(t);if(h.isNull(t))return null;if(!h.isNumber(t))throw new Error("fn7 :: abs,"+h.getType(t));return Math.abs(t)}},random:class extends n{minArguments(){return 0}maxArguments(){return 0}optimize(){return this}evaluate(t){return this.Expr.checkEvaluationLimits(this),Math.random()}},min:class extends n{minArguments(){return 1}maxArguments(){return 1}optimize(){return this.arguments[0]instanceof P?super.optimize():this}evaluate(t){this.Expr.checkEvaluationLimits(this);t=this.arguments[0].evaluate(t);if(h.isNull(t))return null;if(!h.isArray(t))throw new Error("fn1 :: min,"+h.getType(t));if(0===t.length)return null;let e=null;for(const r of t)h.isNull(r)||null!==e&&!u.isLess(r,e)||(e=r);return e}},max:class extends n{minArguments(){return 1}maxArguments(){return 1}optimize(){return this.arguments[0]instanceof P?super.optimize():this}evaluate(t){this.Expr.checkEvaluationLimits(this);t=this.arguments[0].evaluate(t);if(h.isNull(t))return null;if(!h.isArray(t))throw new Error("fn1 :: max,"+h.getType(t));if(0===t.length)return null;let e=null;for(const r of t)h.isNull(r)||null!==e&&!u.isGreater(r,e)||(e=r);return e}},pow:class extends n{minArguments(){return 2}maxArguments(){return 2}evaluate(t){this.Expr.checkEvaluationLimits(this);var e=this.arguments[0].evaluate(t),t=this.arguments[1].evaluate(t);if(h.isNull(e)||h.isNull(t))return null;if(!h.isNumber(e))throw new Error("fn2 :: pow,1st,"+h.getType(e));if(!h.isNumber(t))throw new Error("fn2 :: pow,2nd,"+h.getType(t));t=Math.pow(e,t);if(t>h.DOUBLE_RANGE)throw new Error("pow3");if(h.isNaN(t))throw new Error("pow4");return t}},sqrt:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(t){this.Expr.checkEvaluationLimits(this);t=this.arguments[0].evaluate(t);if(h.isNull(t))return null;if(!h.isNumber(t))throw new Error("fn7 :: sqrt,"+h.getType(t));if(t<0)throw new Error("sqrt2");return Math.sqrt(t)}},log:class extends n{minArguments(){return 2}maxArguments(){return 2}evaluate(t){this.Expr.checkEvaluationLimits(this);var e=this.arguments[0].evaluate(t),t=this.arguments[1].evaluate(t);if(h.isNull(e)||h.isNull(t))return null;if(!h.isNumber(e))throw new Error("fn2 :: log,1st,"+h.getType(e));if(e<=0)throw new Error("log3");if(!h.isNumber(t))throw new Error("fn2 :: log,2nd,"+h.getType(t));if(t<=0||1===t)throw new Error("log4");return Math.log(e)/Math.log(t)}},exp:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(t){this.Expr.checkEvaluationLimits(this);t=this.arguments[0].evaluate(t);if(h.isNull(t))return null;if(!h.isNumber(t))throw new Error("fn7 :: exp,"+h.getType(t));return Math.exp(t)}},trunc:class extends n{minArguments(){return 1}maxArguments(){return 2}evaluate(t){this.Expr.checkEvaluationLimits(this);var e=this.arguments[0].evaluate(t);let r=0;if(1<this.arguments.length&&(r=this.arguments[1].evaluate(t)),h.isNull(e)||h.isNull(r))return null;if(!h.isNumber(e))throw new Error("fn7 :: trunc,"+h.getType(e));if(!h.isNumber(r))throw new Error("convert3 :: "+h.getType(r)+",number");if(r<-20||100<r)throw new Error("trunc2 :: "+r);t=Math.pow(10,r);return h.fixNegativeZero(Math.trunc(e*t)/t)}},acos:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(t){this.Expr.checkEvaluationLimits(this);t=this.arguments[0].evaluate(t);if(h.isNull(t))return null;if(!h.isNumber(t))throw new Error("fn7 :: acos,"+h.getType(t));if(t<-1||1<t)throw new Error("acos2 :: "+o.toString(t));return Math.acos(t)}},acosh:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(t){this.Expr.checkEvaluationLimits(this);t=this.arguments[0].evaluate(t);if(h.isNull(t))return null;if(!h.isNumber(t))throw new Error("fn7 :: acosh,"+h.getType(t));if(t<1)throw new Error("acosh2 :: "+t);return Math.acosh(t)}},asin:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(t){this.Expr.checkEvaluationLimits(this);t=this.arguments[0].evaluate(t);if(h.isNull(t))return null;if(!h.isNumber(t))throw new Error("fn7 :: asin,"+h.getType(t));if(t<-1||1<t)throw new Error("asin2 :: "+o.toString(t));return Math.asin(t)}},asinh:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(t){this.Expr.checkEvaluationLimits(this);t=this.arguments[0].evaluate(t);if(h.isNull(t))return null;if(!h.isNumber(t))throw new Error("fn7 :: asinh,"+h.getType(t));return Math.asinh(t)}},atan2:class extends n{minArguments(){return 2}maxArguments(){return 2}evaluate(t){this.Expr.checkEvaluationLimits(this);var e=this.arguments[0].evaluate(t),t=this.arguments[1].evaluate(t);if(h.isNull(e)||h.isNull(t))return null;if(!h.isNumber(e))throw new Error("fn7 :: atan2,"+h.getType(e));if(!h.isNumber(t))throw new Error("fn7 :: atan2,"+h.getType(t));return Math.atan2(e,t)}},atan:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(t){this.Expr.checkEvaluationLimits(this);t=this.arguments[0].evaluate(t);if(h.isNull(t))return null;if(!h.isNumber(t))throw new Error("fn7 :: atan,"+h.getType(t));return Math.atan(t)}},atanh:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(t){this.Expr.checkEvaluationLimits(this);t=this.arguments[0].evaluate(t);if(h.isNull(t))return null;if(!h.isNumber(t))throw new Error("fn7 :: atanh,"+h.getType(t));if(t<-1||1<t)throw new Error("atanh2 :: "+o.toString(t));return Math.atanh(t)}},cos:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(t){this.Expr.checkEvaluationLimits(this);t=this.arguments[0].evaluate(t);if(h.isNull(t))return null;if(!h.isNumber(t))throw new Error("fn7 :: cos,"+h.getType(t));if(h.isInfinite(t))throw new Error("cos2");return Math.cos(t)}},cosh:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(t){this.Expr.checkEvaluationLimits(this);t=this.arguments[0].evaluate(t);if(h.isNull(t))return null;if(!h.isNumber(t))throw new Error("fn7 :: cosh,"+h.getType(t));return Math.cosh(t)}},sin:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(t){this.Expr.checkEvaluationLimits(this);t=this.arguments[0].evaluate(t);if(h.isNull(t))return null;if(!h.isNumber(t))throw new Error("fn7 :: sin,"+h.getType(t));if(h.isInfinite(t))throw new Error("sin2");return Math.sin(t)}},sinh:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(t){this.Expr.checkEvaluationLimits(this);t=this.arguments[0].evaluate(t);if(h.isNull(t))return null;if(!h.isNumber(t))throw new Error("fn7 :: sinh,"+h.getType(t));return Math.sinh(t)}},tan:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(t){this.Expr.checkEvaluationLimits(this);t=this.arguments[0].evaluate(t);if(h.isNull(t))return null;if(!h.isNumber(t))throw new Error("fn7 :: tan,"+h.getType(t));if(h.isInfinite(t))throw new Error("tan2");return Math.tan(t)}},tanh:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(t){this.Expr.checkEvaluationLimits(this);t=this.arguments[0].evaluate(t);if(h.isNull(t))return null;if(!h.isNumber(t))throw new Error("fn7 :: tanh,"+h.getType(t));return Math.tanh(t)}},toBoolean:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(t){return this.Expr.checkEvaluationLimits(this),o.toBoolean(this.arguments[0].evaluate(t))}},toString:class extends n{minArguments(){return 1}maxArguments(){return 1}optimize(){return this}evaluate(t){return this.Expr.checkEvaluationLimits(this),o.toString(this.arguments[0].evaluate(t))}},toNumber:class extends n{minArguments(){return 1}maxArguments(){return 1}optimize(){return this}evaluate(t){return this.Expr.checkEvaluationLimits(this),o.toNumber(this.arguments[0].evaluate(t))}},toDate:class extends n{minArguments(){return 1}maxArguments(){return 1}optimize(){return this}evaluate(t){return this.Expr.checkEvaluationLimits(this),o.toDate(this.arguments[0].evaluate(t))}},join:N,call:class extends n{minArguments(){return 2}maxArguments(){return 2}evaluate(t){throw this.Expr.checkEvaluationLimits(this),new Error("general2 :: call")}},not:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(t){return this.Expr.checkEvaluationLimits(this),!o.toBoolean(this.arguments[0].evaluate(t))}},let:w,map:class extends n{minArguments(){return 2}maxArguments(){return 2}optimize(){for(let t=0;t<this.arguments.length;t++)this.arguments[t]=this.arguments[t].optimize();return this}evaluate(r){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(r);if(h.isNull(t))return null;if(h.isArray(t))return t.map(t=>{const e=Object.assign({},r);return e.item=t,this.arguments[1].evaluate(e)});throw new Error("fn1 :: map,"+h.getType(t))}localVariableList(){return["item"]}},filter:class extends n{minArguments(){return 2}maxArguments(){return 2}optimize(){for(let t=0;t<this.arguments.length;t++)this.arguments[t]=this.arguments[t].optimize();return this}evaluate(r){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(r);if(h.isNull(t))return null;if(h.isArray(t)){const n=[];return t.forEach(t=>{const e=Object.assign({},r);e.item=t,o.toBoolean(this.arguments[1].evaluate(e))&&n.push(t)}),n}throw new Error("fn1 :: filter,"+h.getType(t))}localVariableList(){return["item"]}},reduce:class extends n{minArguments(){return 3}maxArguments(){return 3}optimize(){for(let t=0;t<this.arguments.length;t++)this.arguments[t]=this.arguments[t].optimize();return this}evaluate(n){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(n);if(h.isNull(t))return null;if(h.isArray(t)){let r=this.arguments[2].evaluate(n);return t.forEach(t=>{const e=Object.assign({},n);e.item=t,e.value=r,r=this.arguments[1].evaluate(e)}),r}throw new Error("fn1 :: reduce,"+h.getType(t))}localVariableList(){return["value","item"]}},range:class extends n{minArguments(){return 2}maxArguments(){return 3}evaluate(t){this.Expr.checkEvaluationLimits(this);let e=this.arguments[0].evaluate(t);var r=this.arguments[1].evaluate(t);let n=1;if(2<this.arguments.length&&(n=this.arguments[2].evaluate(t)),!h.isNumber(e))throw new Error("fn2 :: range,1st,"+h.getType(e));if(!h.is32BitInteger(e))throw new Error("fn3 :: range,1st");if(!h.isNumber(r))throw new Error("fn2 :: range,2nd,"+h.getType(r));if(!h.is32BitInteger(r))throw new Error("fn3 :: range,2nd");if(!h.isNumber(n))throw new Error("fn2 :: range,3rd,"+h.getType(n));if(!h.is32BitInteger(n))throw new Error("fn3 :: range,3rd");if(0===n)throw new Error("range7");var s=Math.max(Math.ceil((r-e)/n),0);const i=Array(s);for(let t=0;t<s;t++,e+=n)i[t]=e;return i}},count:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(t){this.Expr.checkEvaluationLimits(this);t=this.arguments[0].evaluate(t);if(h.isArray(t))return t.length;throw new Error("fn1 :: count,"+h.getType(t))}},reverse:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(t){this.Expr.checkEvaluationLimits(this);t=this.arguments[0].evaluate(t);if(h.isNull(t))return null;if(h.isArray(t))return[...t].reverse();throw new Error("fn1 :: reverse,"+h.getType(t))}},merge:class extends n{minArguments(){return 1}maxArguments(){return 20}evaluate(t){this.Expr.checkEvaluationLimits(this);const e=[];for(const n of this.arguments){var r=n.evaluate(t);if(h.isNull(r))return null;if(!h.isArray(r))throw new Error("fn1 :: merge,"+h.getType(r));e.push(...r)}return e}},sort:class extends n{minArguments(){return 1}maxArguments(){return 2}optimize(){for(let t=0;t<this.arguments.length;t++)this.arguments[t]=this.arguments[t].optimize();return this}evaluate(r){this.Expr.checkEvaluationLimits(this);const t=this.arguments[0].evaluate(r);if(h.isNull(t))return null;if(h.isArray(t))return 1<this.arguments.length?t.map(t=>{const e=Object.assign({},r);return{item:e.item=t,order:this.arguments[1].evaluate(e)}}).sort(function(t,e){return u.isGreater(t.order,e.order)?1:u.isLess(t.order,e.order)?-1:0}).map(t=>t.item):t.sort(function(t,e){return u.isGreater(t,e)?1:u.isLess(t,e)?-1:0});throw new Error("fn1 :: sort,"+h.getType(t))}localVariableList(){return["item"]}},slice:class extends n{minArguments(){return 2}maxArguments(){return 3}evaluate(e){this.Expr.checkEvaluationLimits(this);const r=this.arguments[0].evaluate(e);let n=this.arguments[1].evaluate(e);if(h.isNull(r)||h.isNull(n))return null;if(h.isArray(r)){if(!h.isNumber(n))throw new Error("slice3 :: "+h.getType(n));if(!h.isFinite(n)||h.hasFractionalPart(n))throw new Error("fn3 :: slice,2nd");n<-r.length&&(n=-r.length);let t;if(2<this.arguments.length){if(t=this.arguments[2].evaluate(e),h.isNull(t))return null;if(!h.isFinite(t)||h.hasFractionalPart(t))throw new Error("fn3 :: slice,3rd");if(t<=0)throw new Error("slice2 :: "+t)}else t=void 0;return r.slice(n,t&&n+t)}throw new Error("fn1 :: slice,"+h.getType(r))}},indexOf:class extends n{minArguments(){return 2}maxArguments(){return 2}evaluate(t){this.Expr.checkEvaluationLimits(this);var r=this.arguments[0].evaluate(t);if(h.isNull(r))return null;var n=this.arguments[1].evaluate(t);if(h.isArray(r)){let t=-1,e=0;for(const s of r){if(u.isEqual(s,n)){t=e;break}e++}return t}throw new Error("indexOf1 :: "+h.getType(r))}},unique:class extends n{minArguments(){return 1}maxArguments(){return 1}optimize(){return this}evaluate(t){this.Expr.checkEvaluationLimits(this);var n=this.arguments[0].evaluate(t);if(h.isNull(n))return null;if(h.isArray(n)){const s=[];for(let r=0;r<n.length;r++){let e=!0;for(let t=0;t<s.length;t++)if(u.isEqual(n[r],s[t])){e=!1;break}e&&s.push(n[r])}return s}throw new Error("unique1 :: "+h.getType(n))}},type:class extends n{minArguments(){return 1}maxArguments(){return 1}optimize(){return this}evaluate(t){return this.Expr.checkEvaluationLimits(this),h.getType(this.arguments[0].evaluate(t))}},exists:class extends n{minArguments(){return 1}maxArguments(){return 1}constructor(t,e){if(super(t,e),!(this.arguments[0]instanceof _||this.arguments[0]instanceof j||this.arguments[0]instanceof M||this.arguments[0]instanceof S||this.arguments[0]instanceof L||this.arguments[0]instanceof P||this.arguments[0]instanceof $||this.arguments[0]instanceof D||this.arguments[0]instanceof r))throw new Error("exists1");(this.arguments[0]instanceof D||this.arguments[0]instanceof r)&&this.arguments[0].enableExistsMode()}optimize(){return this}evaluate(t){return this.Expr.checkEvaluationLimits(this),this.arguments[0]instanceof _||this.arguments[0]instanceof j||this.arguments[0]instanceof M||this.arguments[0]instanceof S||this.arguments[0]instanceof L||this.arguments[0]instanceof P||this.arguments[0]instanceof $||(this.arguments[0]instanceof l||(this.arguments[0]instanceof D||this.arguments[0]instanceof r)&&this.arguments[0].evaluateExists(t))}},now:class extends n{minArguments(){return 0}maxArguments(){return 0}evaluate(t){this.Expr.checkEvaluationLimits(this);const e=new Date;return e.setMilliseconds(0),e}},dateAdd:class extends n{minArguments(){return 3}maxArguments(){return 3}optimize(){return this.arguments[0]instanceof S?this.arguments[0].optimize():super.optimize()}evaluate(t){this.Expr.checkEvaluationLimits(this);var e=this.arguments[0].evaluate(t),r=this.arguments[1].evaluate(t);if(h.isNull(r))return null;if(!h.isString(r))throw new Error("dateAdd1 :: "+h.getType(r));if(!["year","quarter","week","month","day","hour","minute","second","millisecond"].includes(r))throw new Error("dateAdd3");if(h.isNull(e))return null;if(h.isDate(e)){t=this.arguments[2].evaluate(t);if(h.isNull(t))return null;if(h.isNumber(t)){if(Math.trunc(t)!==t)throw new Error("dateAdd4");if("year"===r)return this.addMonths(e,12*t);if("quarter"===r)return this.addMonths(e,3*t);if("week"===r)return this.addDays(e,7*t);if("month"===r)return this.addMonths(e,t);if("day"===r)return this.addDays(e,t);if("hour"===r)return this.addMinutes(e,60*t);if("minute"===r)return this.addMinutes(e,t);if("second"===r)return this.addMilliseconds(e,1e3*t);if("millisecond"===r)return this.addMilliseconds(e,t);throw new Error("dateAdd3")}throw new Error("dateAdd4")}throw new Error("dateAdd2")}addMonths(t,e){const r=new Date(t);t=r.getUTCDate();return r.setUTCMonth(r.getUTCMonth()+e),r.getUTCDate()!==t&&r.setUTCDate(0),r}addDays(t,e){const r=new Date(t);return r.setUTCDate(r.getUTCDate()+e),r}addMinutes(t,e){return this.addMilliseconds(t,1e3*e*60)}addMilliseconds(t,e){return new Date(+t+e)}},dateSubtract:class extends n{minArguments(){return 3}maxArguments(){return 3}optimize(){return this.arguments[0]instanceof S?this.arguments[0].optimize():super.optimize()}evaluate(t){this.Expr.checkEvaluationLimits(this);var e=this.arguments[0].evaluate(t),r=this.arguments[1].evaluate(t);if(h.isNull(r))return null;if(!h.isString(r))throw new Error("dateSubtract1 :: "+h.getType(r));if(!["year","quarter","week","month","day","hour","minute","second","millisecond"].includes(r))throw new Error("dateSubtract3");if(h.isNull(e))return null;if(h.isDate(e)){t=this.arguments[2].evaluate(t);if(h.isNull(t))return null;if(h.isNumber(t)){if(Math.trunc(t)!==t)throw new Error("dateSubtract4");if("year"===r)return this.subtractMonths(e,12*t);if("quarter"===r)return this.subtractMonths(e,3*t);if("week"===r)return this.subtractDays(e,7*t);if("month"===r)return this.subtractMonths(e,t);if("day"===r)return this.subtractDays(e,t);if("hour"===r)return this.subtractMinutes(e,60*t);if("minute"===r)return this.subtractMinutes(e,t);if("second"===r)return this.subtractMilliseconds(e,1e3*t);if("millisecond"===r)return this.subtractMilliseconds(e,t);throw new Error("dateSubtract3")}throw new Error("dateSubtract4")}throw new Error("dateSubtract2")}subtractMonths(t,e){const r=new Date(t);t=r.getUTCDate();return r.setUTCMonth(r.getUTCMonth()-e),r.getUTCDate()!==t&&r.setUTCDate(0),r}subtractDays(t,e){const r=new Date(t);return r.setUTCDate(r.getUTCDate()-e),r}subtractMinutes(t,e){return this.subtractMilliseconds(t,1e3*e*60)}subtractMilliseconds(t,e){return new Date(+t-e)}},length:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(t){this.Expr.checkEvaluationLimits(this);t=this.arguments[0].evaluate(t);if(h.isString(t))return t.length;throw new Error("fn6 :: length,"+h.getType(t))}},substr:class extends n{minArguments(){return 1}maxArguments(){return 3}constructor(t,e){1===(e=[...e]).length&&e.push({type:"Number",value:0}),2===e.length&&e.push({type:"Number",value:h.INT32_RANGE}),super(t,e)}evaluate(t){this.Expr.checkEvaluationLimits(this);let e=this.arguments[0].evaluate(t);var r=this.arguments[1].evaluate(t),t=this.arguments[2].evaluate(t);if(h.isNumber(e)||h.isBoolean(e))e=o.toString(e);else{if(h.isNull(e))return"";if(!h.isString(e)&&!h.isDate(e))throw new Error("convert1 :: "+h.getType(e)+",string")}if(!h.isNumber(r))throw new Error("fn2 :: substr,2nd,"+h.getType(r));if(!h.is32BitInteger(r))throw new Error("fn3 :: substr,2nd");if(!h.isNumber(t))throw new Error("fn2 :: substr,3rd,"+h.getType(t));if(!h.is32BitInteger(t))throw new Error("fn3 :: substr,3rd");if(r<0)throw new Error("substr3");if(t<0)throw new Error("substr5");return h.isDate(e)&&(e=o.toString(e)),e.substr(r,t)}},locate:class extends n{minArguments(){return 2}maxArguments(){return 3}evaluate(t){this.Expr.checkEvaluationLimits(this);const e=this.arguments[0].evaluate(t);var r=this.arguments[1].evaluate(t);if(h.isNull(e))return null;if(!h.isString(e))throw new Error("fn5 :: locate,1st,"+h.getType(e));if(!h.isString(r))throw new Error("fn5 :: locate,2nd,"+h.getType(r));let n=0;return 2<this.arguments.length&&(n=this.arguments[2].evaluate(t)),e.indexOf(r,n)}},trim:A,trimStart:class extends n{minArguments(){return 1}maxArguments(){return 1}trimStart(t,e){let r=0;for(var n=t.length;r<n&&0<=e.indexOf(t[r]);)++r;return 0<r||n<t.length?t.substring(r,n):t}evaluate(t){this.Expr.checkEvaluationLimits(this);t=this.arguments[0].evaluate(t);if(h.isNull(t))return null;if(h.isString(t))return this.trimStart(t,A.WHITESPACE);throw new Error("fn6 :: trimStart,"+h.getType(t))}},trimEnd:class extends n{minArguments(){return 1}maxArguments(){return 1}trimEnd(t,e){let r=t.length;for(;0<r&&0<=e.indexOf(t[r-1]);)--r;return r<t.length?t.substring(0,r):t}evaluate(t){this.Expr.checkEvaluationLimits(this);t=this.arguments[0].evaluate(t);if(h.isNull(t))return null;if(h.isString(t))return this.trimEnd(t,A.WHITESPACE);throw new Error("fn6 :: trimEnd,"+h.getType(t))}},split:class extends n{minArguments(){return 2}maxArguments(){return 2}evaluate(t){this.Expr.checkEvaluationLimits(this);const e=this.arguments[0].evaluate(t);t=this.arguments[1].evaluate(t);if(h.isNull(e)||h.isNull(t))return null;if(!h.isString(e))throw new Error("fn5 :: split,1st,"+h.getType(e));if(!h.isString(t))throw new Error("fn5 :: split,2nd,"+h.getType(t));if(""===t)throw new Error("split3");return e.split(t)}},replace:class extends n{minArguments(){return 3}maxArguments(){return 3}optimize(){for(let t=0;t<this.arguments.length;t++)this.arguments[t]=this.arguments[t].optimize();return this}evaluate(t){this.Expr.checkEvaluationLimits(this);let e=this.arguments[0].evaluate(t);var r=this.arguments[1].evaluate(t),t=this.arguments[2].evaluate(t);if(!h.isNull(e)&&!h.isString(e))throw new Error("fn5 :: replace,1st,"+h.getType(e));if(!h.isNull(r)&&!h.isString(r))throw new Error("fn5 :: replace,2nd,"+h.getType(r));if(!h.isNull(t)&&!h.isString(t))throw new Error("fn5 :: replace,3rd,"+h.getType(t));return h.isNull(e)||h.isNull(r)||h.isNull(t)?null:e.replace(r,t)}},replaceAll:class extends n{minArguments(){return 3}maxArguments(){return 3}optimize(){for(let t=0;t<this.arguments.length;t++)this.arguments[t]=this.arguments[t].optimize();return this}evaluate(t){this.Expr.checkEvaluationLimits(this);var e=this.arguments[0].evaluate(t),r=this.arguments[1].evaluate(t),n=this.arguments[2].evaluate(t);if(!h.isNull(e)&&!h.isString(e))throw new Error("fn5 :: replaceAll,1st,"+h.getType(e));if(!h.isNull(r)&&!h.isString(r))throw new Error("fn5 :: replaceAll,2nd,"+h.getType(r));if(!h.isNull(n)&&!h.isString(n))throw new Error("fn5 :: replaceAll,3rd,"+h.getType(n));if(h.isNull(e)||h.isNull(r)||h.isNull(n))return null;let s=e,i,a=0;for(;!((i=s.indexOf(r,a))<0);)s=s.substr(0,i)+n+s.substr(i+r.length),a=i+n.length;return s}},lower:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(t){this.Expr.checkEvaluationLimits(this);const e=this.arguments[0].evaluate(t);if(h.isNull(e))return null;if(h.isString(e))return e.toLowerCase();throw new Error("fn6 :: lower,"+h.getType(e))}},upper:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(t){this.Expr.checkEvaluationLimits(this);const e=this.arguments[0].evaluate(t);if(h.isNull(e))return null;if(h.isString(e))return e.toUpperCase();throw new Error("fn6 :: upper,"+h.getType(e))}},regexTest:O,regexMatch:class extends n{minArguments(){return 2}maxArguments(){return 3}optimize(){if(this.arguments[1]=this.arguments[1].optimize(),this.arguments[1]instanceof l&&!h.isNull(this.arguments[1].result)&&!h.isString(this.arguments[1].result))throw new Error("fn4 :: regexMatch,2nd");return this}evaluate(t){this.Expr.checkEvaluationLimits(this);var e=this.arguments[0].evaluate(t),r=this.arguments[1].evaluate(t);if(h.isNull(e))return null;if(!h.isString(e))throw new Error("fn4 :: regexMatch,1st");if(h.isNull(r))return null;if(!h.isString(r))throw new Error("fn4 :: regexMatch,2nd");let n="";if(2<this.arguments.length){if(!(this.arguments[2]instanceof j))throw new Error("regexMatch3");if(n=this.arguments[2].evaluate(t),!O.validateFlags(n))throw new Error("regexMatch4")}let s;try{s=new RegExp(r,n+"u")}catch(t){throw new Error("regexMatch3")}const i=s.exec(e);return i?{match:i[0],idx:i.index,captures:i.slice(1).map(t=>void 0===t?null:t)}:null}},regexMatchAll:class extends n{minArguments(){return 2}maxArguments(){return 3}optimize(){if(this.arguments[1]=this.arguments[1].optimize(),this.arguments[1]instanceof l&&!h.isNull(this.arguments[1].result)&&!h.isString(this.arguments[1].result))throw new Error("fn4 :: regexMatchAll,2nd");return this}evaluate(t){this.Expr.checkEvaluationLimits(this);var e=this.arguments[0].evaluate(t),r=this.arguments[1].evaluate(t);if(h.isNull(e))return[];if(!h.isString(e))throw new Error("fn4 :: regexMatchAll,1st");if(h.isNull(r))return[];if(!h.isString(r))throw new Error("fn4 :: regexMatchAll,2nd");let n="";if(2<this.arguments.length){if(!(this.arguments[2]instanceof j))throw new Error("regexMatchAll3");if(n=this.arguments[2].evaluate(t),!O.validateFlags(n))throw new Error("regexMatchAll4")}let s;try{s=new RegExp(r,n+"ug")}catch(t){throw new Error("regexMatchAll3")}const i=[];let a;for(;null!==(a=s.exec(e));)i.push({match:a[0],idx:a.index,captures:a.slice(1).map(t=>void 0===t?null:t)});return i}},objectToArray:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(t){this.Expr.checkEvaluationLimits(this);var e=this.arguments[0].evaluate(t);if(h.isNull(e))return null;if(h.isObject(e)){const r=[];for(const n in e)r.push({k:n,v:e[n]});return r}throw new Error("objectToArray1 :: "+h.getType(e))}},arrayToObject:class extends n{minArguments(){return 1}maxArguments(){return 1}evaluate(e){this.Expr.checkEvaluationLimits(this);e=this.arguments[0].evaluate(e);if(h.isNull(e))return null;if(h.isArray(e)){const n={};let t=null;for(const s of e){if("array"===t){if(!h.isArray(s))throw new Error("arrayToObject5 :: array,"+h.getType(s))}else if("object"===t){if(!h.isObject(s))throw new Error("arrayToObject5 :: object,"+h.getType(s))}else if(h.isArray(s))t="array";else{if(!h.isObject(s))throw new Error("arrayToObject2 :: "+h.getType(s));t="object"}if("array"===t){if(2!==s.length)throw new Error("arrayToObject4 :: "+s.length);if(!h.isString(s[0]))throw new Error("arrayToObject3 :: "+h.getType(s[0]));n[s[0]]=s[1]}else if("object"===t){var r=Object.keys(s).length;if(2!==r)throw new Error("arrayToObject7 :: "+r);if(!s.hasOwnProperty("k")||!s.hasOwnProperty("v"))throw new Error("arrayToObject8");if(!h.isString(s.k))throw new Error("arrayToObject6 :: "+h.getType(s.k));n[s.k]=s.v}}return n}throw new Error("arrayToObject1 :: "+h.getType(e))}}},z.UNARY_OPERATORS={"+":T,"-":b},z.BINARY_OPERATORS={"&":N,"+":T,"-":b,"*":x,"/":v,"%":y,"==":i,"!=":a,">":c,">=":g,"<":f,"<=":p,or:E,and:d,"??":k,in:s},z.LIMIT_MODE_NONE=0,z.LIMIT_MODE_10K=1,z.LIMIT_MODE_1M=2,t.Expression=z,Object.defineProperty(t,"__esModule",{value:!0}),t}({});